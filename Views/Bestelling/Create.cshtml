@model BestellingCreateViewModel
@{
    ViewData["Title"] = "Menu";
}

<h2>Menu</h2>

@if (!Model.HasAssignedTable)
{
    <div class="alert alert-warning">
        U heeft nog geen tafel toegewezen. <strong>Check eerst in bij de zaalverantwoordelijke.</strong>
    </div>
}
else
{
    <form asp-action="Create" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="ReservatieId" />
        <input type="hidden" id="CartItemsJson" name="CartItemsJson" value='@Html.Raw(ViewBag.CartItemsJson ?? "[]")' />

        <div class="row">
            <!-- Menu (2/3) -->
            <div class="col-md-7">
                <ul class="nav nav-tabs mb-3" id="menuTab" role="tablist">
                    @for (int i = 0; i < Model.MenuTypes.Count; i++)
                    {
                        var type = Model.MenuTypes[i];
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(i == 0 ? "active" : "")" id="type-tab-@i" data-bs-toggle="tab" data-bs-target="#type-@i" type="button" role="tab" aria-controls="type-@i" aria-selected="@(i == 0 ? "true" : "false")">@type.Naam</button>
                        </li>
                    }
                </ul>
                <div class="tab-content" id="menuTabContent">
                    @for (int i = 0; i < Model.MenuTypes.Count; i++)
                    {
                        var type = Model.MenuTypes[i];
                        <div class="tab-pane fade @(i == 0 ? "show active" : "")" id="type-@i" role="tabpanel" aria-labelledby="type-tab-@i">
                            @foreach (var categorie in type.Categorieen)
                            {
                                <div class="mb-3">
                                    <h5>@categorie.Naam</h5>
                                    @if (categorie.Producten != null && categorie.Producten.Any())
                                    {
                                        <ul class="list-group">
                                            @foreach (var product in categorie.Producten)
                                            {
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <strong>@product.Naam</strong> - @product.Beschrijving
                                                        <br />
                                                        <small>Prijs: @String.Format("{0:C}", product.Prijs)</small>
                                                    </span>
                                                    <button type="button" class="btn btn-success btn-sm" onclick="addToCart(@product.Id)">Toevoegen</button>
                                                </li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <div class="text-muted ps-2">Geen producten beschikbaar in deze categorie.</div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Cart (1/3) -->
            <div class="col-md-5">
                <h4>Winkelmandje</h4>
                <table class="table table-sm" style="table-layout: fixed; width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Product</th>
                            <th style="width: 15%;">Aantal</th>
                            <th style="width: 15%;">Prijs</th>
                            <th style="width: 15%;">Totaal</th>
                            <th style="width: 5%;"></th>
                        </tr>
                    </thead>
                    <tbody id="cartTableBody">
                        @if (Model.CartItemsWithProduct.Any())
                        {
                            @foreach (var item in Model.CartItemsWithProduct)
                            {
                                <tr>
                                    <td>@item.Naam</td>
                                    <td>@item.Aantal</td>
                                    <td>@String.Format("{0:C}", item.Prijs)</td>
                                    <td>@String.Format("{0:C}", item.Aantal * item.Prijs)</td>
                                    <td>
                                        <button type="button"
                                                onclick="removeFromCart(@item.ProductId)"
                                                title="Verwijder"
                                                style="background: none; border: none; padding: 0; cursor: pointer;">
                                            <i class="bi bi-trash text-danger"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-muted">Uw winkelmandje is leeg.</td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="fw-bold" id="cartTotal">Totaalbedrag: @Model.TotaalBedrag.ToString("C")</div>

                <button type="submit" class="btn btn-primary mt-3">Bestelling bevestigen</button>
            </div>
        </div>
    </form>
}

@section Scripts {
    <script>
        function addToCart(ProductId) {
            let cartItems = [];
            const cartItemsJson = document.getElementById('CartItemsJson').value;
            if (cartItemsJson) {
                try {
                    cartItems = JSON.parse(cartItemsJson);
                    cartItems = cartItems.filter(ci => ci && typeof ci.ProductId === 'number' && typeof ci.Aantal === 'number');
                } catch { cartItems = []; }
            }

            // Log before sending
            console.log("Sending to server:", cartItems);

            fetch('/api/BestellingApi/AddToCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // Remove 'RequestVerificationToken'
                },
                body: JSON.stringify({ ProductId, CartItemsJson: JSON.stringify(cartItems) })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                // Log the response
                console.log("Received from server:", data);

                const newCart = data.cartItems
                    .filter(item => typeof item.productId === 'number' && typeof item.aantal === 'number')
                    .map(item => ({
                        ProductId: item.productId,
                        Aantal: item.aantal
                    }));
                document.getElementById('CartItemsJson').value = JSON.stringify(newCart);

                // Log what will be rendered
                const validItems = data.cartItems.filter(item =>
                    typeof item.naam === 'string' &&
                    typeof item.aantal === 'number' &&
                    typeof item.prijs === 'number'
                );
                console.log("Rendering in table:", validItems);

                updateCartTable(validItems, data.totaalBedrag);
            })
            .catch(err => {
                console.error("API error:", err);
                alert("Er is een fout opgetreden bij het verwerken van uw winkelmandje.");
            });
        }

        function removeFromCart(ProductId) {
            let cartItems = [];
            const cartItemsJson = document.getElementById('CartItemsJson').value;
            if (cartItemsJson) {
                try {
                    cartItems = JSON.parse(cartItemsJson);
                    cartItems = cartItems.filter(ci => ci && typeof ci.ProductId === 'number' && typeof ci.Aantal === 'number');
                } catch { cartItems = []; }
            }

            fetch('/api/BestellingApi/RemoveFromCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                body: JSON.stringify({ ProductId, cartItemsJson: JSON.stringify(cartItems) })
            })
            .then(response => response.json())
            .then(data => {
                const newCart = data.cartItems
                    .filter(item => typeof item.productId === 'number' && typeof item.aantal === 'number')
                    .map(item => ({
                        ProductId: item.productId,
                        Aantal: item.aantal
                    }));
                document.getElementById('CartItemsJson').value = JSON.stringify(newCart);

                const validItems = data.cartItems.filter(item =>
                    typeof item.naam === 'string' &&
                    typeof item.aantal === 'number' &&
                    typeof item.prijs === 'number'
                );
                updateCartTable(validItems, data.totaalBedrag);
            });
        }

        function updateCartTable(cartItems, totaalBedrag) {
            const tbody = document.getElementById('cartTableBody');
            tbody.innerHTML = '';
            if (!cartItems || cartItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Uw winkelmandje is leeg.</td></tr>';
            } else {
                cartItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.naam}</td>
                        <td>${item.aantal}</td>
                        <td>${item.prijs.toLocaleString('nl-BE', { style: 'currency', currency: 'EUR' })}</td>
                        <td>${(item.aantal * item.prijs).toLocaleString('nl-BE', { style: 'currency', currency: 'EUR' })}</td>
                        <td>
                            <button type="button" onclick="removeFromCart(${item.productId})" title="Verwijder"
                                style="background: none; border: none; padding: 0; cursor: pointer;">
                                <i class="bi bi-trash text-danger"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            document.getElementById('cartTotal').innerText = 'Totaalbedrag: ' +
                (typeof totaalBedrag === 'number'
                    ? totaalBedrag.toLocaleString('nl-BE', { style: 'currency', currency: 'EUR' })
                    : '€ 0,00');
        }
    </script>
}
