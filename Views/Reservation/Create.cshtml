@model Restaurant.ViewModels.Reservation.ReservationViewModel
@{
    ViewData["Title"] = "Tafel reserveren";
}

<div class="container mt-3">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h2 class="mb-4">Tafel reserveren</h2>

            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

            <form method="post" id="reservationForm" novalidate>
                @Html.AntiForgeryToken()

                <div class="mb-3">
                    <label asp-for="Datum" class="form-label">Datum</label>
                    <input asp-for="Datum"
                           class="form-control"
                           type="date"
                           min="@DateTime.Today.ToString("yyyy-MM-dd")"
                           data-val="true"
                           data-val-min="Datum kan niet in het verleden liggen."
                           data-val-min-min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    <span asp-validation-for="Datum" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="AantalPersonen" class="form-label">Aantal personen</label>
                    <input asp-for="AantalPersonen" class="form-control" type="number" />
                    <span asp-validation-for="AantalPersonen" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label" for="TijdSlotId">Tijdslot</label>

                    <div>
                        <strong>Lunch</strong>
                        <div class="row" id="lunchTijdslotCards">
                            @foreach (var slot in Model.LunchTijdsloten)
                            {
                                <div class="col-6 mb-3">
                                    <div class="card tijdslot-card" data-id="@slot.Id" data-naam="@slot.Naam" tabindex="0" style="cursor:pointer;">
                                        <div class="card-body text-center">
                                            <span>@slot.Naam</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div>
                        <strong>Diner</strong>
                        <div class="row" id="dinerTijdslotCards">
                            @foreach (var slot in Model.DinerTijdsloten)
                            {
                                <div class="col-6 mb-3">
                                    <div class="card tijdslot-card" data-id="@slot.Id" data-naam="@slot.Naam" tabindex="0" style="cursor:pointer;">
                                        <div class="card-body text-center">
                                            <span>@slot.Naam</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <input type="hidden" asp-for="TijdSlotId" id="TijdSlotId" />
                    <span asp-validation-for="TijdSlotId" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Opmerking" class="form-label">Speciale verzoeken</label>
                    <textarea asp-for="Opmerking" class="form-control" rows="2"></textarea>
                </div>

                <button type="submit" class="btn btn-custom-primary w-100">Reserveer</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Helper: parse "tot 12u30" or "tot 19u" from tijdslot string
        function parseEndTime(naam) {
            var match = naam.match(/tot\s*(\d{1,2})u(\d{0,2})?/i);
            if (match) {
                var hour = parseInt(match[1], 10);
                var minute = match[2] ? parseInt(match[2], 10) : 0;
                return { hour: hour, minute: minute };
            }
            return null;
        }

        function updateTijdslotCards() {
            var dateInput = document.getElementById('Datum');
            var selectedDate = dateInput ? new Date(dateInput.value) : null;
            var today = new Date();
            var isToday = selectedDate &&
                selectedDate.getFullYear() === today.getFullYear() &&
                selectedDate.getMonth() === today.getMonth() &&
                selectedDate.getDate() === today.getDate();

            document.querySelectorAll('.tijdslot-card').forEach(function (card) {
                var naam = card.getAttribute('data-naam');
                var endTime = parseEndTime(naam);
                card.classList.remove('disabled', 'bg-light', 'text-muted');
                card.style.pointerEvents = '';
                if (isToday && endTime) {
                    var slotEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endTime.hour, endTime.minute);
                    if (slotEnd <= today) {
                        card.classList.add('disabled', 'bg-light', 'text-muted');
                        card.style.pointerEvents = 'none';
                        // If this card was selected, clear selection
                        if (document.getElementById('TijdSlotId').value === card.getAttribute('data-id')) {
                            document.getElementById('TijdSlotId').value = '';
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Card selectie logica
            document.querySelectorAll('.tijdslot-card').forEach(card => {
                card.addEventListener('click', function () {
                    if (this.classList.contains('disabled')) return;
                    document.querySelectorAll('.tijdslot-card').forEach(c => c.classList.remove('border-primary', 'shadow'));
                    this.classList.add('border-primary', 'shadow');
                    document.getElementById('TijdSlotId').value = this.getAttribute('data-id');
                });
                card.addEventListener('keydown', function (e) {
                    if ((e.key === "Enter" || e.key === " ") && !this.classList.contains('disabled')) {
                        e.preventDefault();
                        this.click();
                    }
                });
            });

            // Update cards on page load and when date changes
            updateTijdslotCards();
            var dateInput = document.getElementById('Datum');
            if (dateInput) {
                dateInput.addEventListener('change', updateTijdslotCards);
            }

            // Form validatie: tijdslot moet gekozen zijn (extra UX)
            document.getElementById('reservationForm').addEventListener('submit', function (e) {
                if (!document.getElementById('TijdSlotId').value) {
                    e.preventDefault();
                    alert('Kies een tijdslot.');
                }
            });
        });
    </script>
}